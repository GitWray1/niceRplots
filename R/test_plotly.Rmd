---
title: "Test plotly themes"
author: "Impact team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Install and load packages
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, plotly)

# Declare location
here::i_am("R/plotly_theme.R")

# Load here package
pacman::p_load(here)

# Load NICE colours
source(here("R", "load_nice_colours.R"))

# Load Plotly themes
source(here("R", "plotly_theme.R"))
```

# Interactive charts

## Plotly

### Styling a Plotly chart

```{r format_plotly, fig.show = "hold", out.width = "50%"}
# Wrangle data for plotting
iris_bar_df <- iris %>% 
  group_by(Species) %>% 
  summarise(Sepal_Width = mean(Sepal.Width)) %>% 
  ungroup()

# Create basic bar chart (left)
plotly_iris_bar <- plot_ly(iris_bar_df,
                    x = ~Species,
                    y = ~Sepal_Width,
                    type = "bar")

# Create formatted chart (right)
plotly_iris_bar_formatted <- plot_ly(iris_bar_df,
                    x = ~Species,
                    y = ~Sepal_Width,
                    type = "bar",
                    marker = list(color = nice_colours[["bold_teal_100"]],
                                  line = list(color = nice_colours[['black_100']], width = 1.5)))

plotly_iris_bar
plotly_iris_bar_formatted

# fig.show = "hold" not working for Plotly?
```

```{r theme_plotly}
plotly_iris_bar_themed <- plotly_iris_bar_formatted %>% 
  nice_plotly_theme(chart_type = "vertical_bar",
             x_title = "Species",
             y_title = "Sepal Width")
```

#### Formatted chart headline title
##### Figure x. Formatted chart statistical title

```{r theme_plotly_output, echo = FALSE}
plotly_iris_bar_themed
```
Alt text (text description of message chart is showing. Mark chart as decorative)  
Source: []  
Download the data for Figure x (CSV, 5.0KB).

### How to save your plot

To download the plot as a static PNG image, click on the camera icon at the top right of the plot.

Saving in other file formats (e.g. .svg or .jpg) is more complicated and requires installation of another piece of software. Read the [Plotly documentation on exporting graphs as static images in R](https://plotly.com/r/static-image-export/).

### Chart types

```{r load_data, message = FALSE, warning = FALSE, eval = FALSE}

# Load in DOACs data
# here::here("data", "DOACs_data.csv")?
doacs_df <- readr::read_csv(here::here("DOACs_data.csv"),
                              col_types = "Dcccccdddd")

```

#### Histogram

Use chart_type = "horizontal_bar" for histograms.

```{r plotly_histogram}
# Create chart
plotly_hist <- iris %>%
  plot_ly(x = ~Sepal.Width,
          color = ~Species,
          # Use NICE colours - remove colour names so it maps correctly
          colors = unname(nice_palettes[["discrete"]][1:3]),
          type = "histogram",
          # Black outline for bars
          marker = list(line = list(color = nice_colours[['black_100']], width = 1.5)),
          # Set bin width
          xbins = list(size = 0.2,
                       start = 1.9,
                       end = 4.5)) %>% 
  # Stack bars
  layout(barmode = "stack") %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "vertical_bar",
             x_title = "Sepal width",
             y_title = "Frequency")

plotly_hist

# Category order differs from ggplot but no big difference

```

#### Bar chart

##### Vertical bar chart

Use chart_type = "vertical_bar".

```{r plotly_vertical_bar, message = FALSE, warning = FALSE}

# Prepare data, get total items dispensed for each medicine in 2021 (in millions)
bar_df <- doacs_df %>% 
  filter(between(date, as.Date("2021-01-01"), as.Date("2021-12-31"))) %>% 
  group_by(chemical) %>% 
  summarise(items = sum(items)/1000000) %>% 
  ungroup()

# Create chart
plotly_vbar_chart <- bar_df %>%
  mutate() %>% 
  # Plot bars in decreasing order of items
  ggplot(aes(y = items, x = reorder(chemical, -items))) +
  # Add baseline to x axis
  geom_hline(yintercept = 0, linewidth = 1, colour = "#333333") +
  # set y-axis limits and remove padding
  scale_y_continuous(expand = c(0,0), limits = c(0,8)) +
  # set x-axis labels to wrap to prevent overlapping
  scale_x_discrete(labels = function(x) {stringr::str_wrap(x, width = 10)}) +
  # Add bars, add fill and border colours
  geom_col(fill = nice_colours[1], colour = "#000000") +
  # Apply NICE theme
  nice_gg_theme(base_size = 12) +
  # Remove the x-axis title
  theme(axis.title.x = ggplot2::element_blank()) +
  # Add labels
  labs(title = "Apixaban was the most prescribed DOAC in 2021",
       subtitle = "Total DOAC medicines dispensed in primary care in England, 2020",
       y = "Dispensed items (millions)")

bar_chart

```

##### Horizontal bar chart

# Own tests

```{r}
economics_long %>%
  filter(variable != "pop") %>%
  plot_ly(x = ~date,
         y = ~value01,
         color = ~variable,
         colors = c("#00436C", "#D07B4D", "#000000", "#37906D"),
         type = "scatter",
         mode = "lines") %>%
  nice_plotly_theme(chart_type = "line")
```


```{r}
plot1 <- mpg %>%
  filter(manufacturer %in% c("hyundai", "nissan", "toyota")) %>%
  count(manufacturer) %>%
  plot_ly(y = ~manufacturer,
          x = ~n,
          color = ~manufacturer,
          type = "bar",
          orientation = "h",
          marker = list(line = list(color = '#000000', width = 1.5)))

nice_plotly_theme(plot1, chart_type = "horizontal_bar")
```


```{r}
mpg %>%
  filter(manufacturer %in% c("hyundai", "nissan", "toyota")) %>%
  count(manufacturer) %>%
  plot_ly(y = ~manufacturer,
          x = ~n,
          color = ~manufacturer,
          type = "bar",
          orientation = "h",
          marker = list(line = list(color = '#000000', width = 1.5))) %>%
  nice_plotly_theme(chart_type = "horizontal_bar")
```


```{r}
mpg %>%
  filter(manufacturer %in% c("hyundai", "nissan", "toyota")) %>%
  count(manufacturer) %>%
  plot_ly(x = ~manufacturer,
          y = ~n,
          color = ~manufacturer,
          type = "bar",
          marker = list(line = list(color = '#000000', width = 1.5))) %>%
  nice_plotly_theme(chart_type = "vertical_bar")
```

