---
title: "Test plotly themes"
author: "Impact team"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup_plotly, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Install and load packages
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, plotly)

# Declare location
here::i_am("R/plotly_theme.R")

# Load Plotly themes
source(here::here("R", "plotly_theme.R"))

# Load niceRplots
# devtools::load_all()
```

```{r, child = c(here::here('vignettes', 'NICE_cookbook.Rmd')), include = FALSE}
# Run vignette first
# Means do not need to duplicate data wrangling
```

```{r}
# Declare location
here::i_am("R/plotly_theme.R")
```


# Interactive charts

## Plotly

### Styling a Plotly chart

```{r format_plotly, fig.show = "hold", out.width = "50%"}
# Load NICE colours
load(here::here("data", "nice_colours_full.rda"))

# Create basic bar chart (left)
plotly_iris_bar <- plot_ly(iris_bar_df,
                    x = ~Species,
                    y = ~Sepal_Width,
                    type = "bar")

# Create formatted chart (right)
plotly_iris_bar_formatted <- plot_ly(iris_bar_df,
                    x = ~Species,
                    y = ~Sepal_Width,
                    type = "bar",
                    marker = list(color = nice_colours_full[["bold_teal_100"]],
                                  line = list(color = nice_colours_full[['black_100']], width = 1.5)))

plotly_iris_bar
plotly_iris_bar_formatted

# fig.show = "hold" not working for Plotly?
```

```{r theme_plotly}
plotly_iris_bar_themed <- plotly_iris_bar_formatted %>% 
  nice_plotly_theme(chart_type = "vertical_bar",
             x_title = "Species",
             y_title = "Sepal Width")
```

#### Formatted chart headline title
##### Figure x. Formatted chart statistical title

```{r theme_plotly_output, echo = FALSE}
plotly_iris_bar_themed
```
Alt text (text description of message chart is showing. Mark chart as decorative)  
Source: []  
Download the data for Figure x (CSV, 5.0KB).

### How to save your plot

To download the plot as a static PNG image, click on the camera icon at the top right of the plot.

Saving in other file formats (e.g. .svg or .jpg) is more complicated and requires installation of another piece of software. Read the [Plotly documentation on exporting graphs as static images in R](https://plotly.com/r/static-image-export/).

### Tooltip

### Chart types

#### Histogram

Use chart_type = "horizontal_bar" for histograms.

```{r plotly_histogram}
# Create chart
plotly_hist <- iris %>%
  plot_ly(x = ~Sepal.Width,
          color = ~Species,
          # Use NICE colours - remove colour names so it maps correctly
          colors = unname(nice_palettes[["discrete"]][1:3]),
          type = "histogram",
          # Black outline for bars
          marker = list(line = list(color = nice_colours_full[['black_100']], width = 1.5)),
          # Set bin width
          xbins = list(size = 0.2,
                       start = 1.9,
                       end = 4.5)) %>% 
  # Stack bars
  layout(barmode = "stack") %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "vertical_bar",
             x_title = "Sepal width",
             y_title = "Frequency")

plotly_hist

# Category order differs from ggplot but no big difference

```

#### Bar chart

##### Vertical bar chart

Use chart_type = "vertical_bar".

```{r plotly_vertical_bar, message = FALSE, warning = FALSE}
# Create chart
plotly_vbar_chart <- bar_df %>%
  # Reorder chemical factor levels in decreasing order of items
  mutate(chemical = reorder(chemical, -items)) %>% 
  plot_ly(x = ~chemical,
          y = ~items,
          type = "bar",
          # Bold teal bars with black outline
          marker = list(color = nice_colours_full[["bold_teal_100"]],
                        line = list(color = nice_colours_full[['black_100']], width = 1.5))) %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "vertical_bar",
             x_title = "",
             y_title = "Dispensed items (millions)")
```

**Apixaban was the most prescribed DOAC in 2021**  

Figure x. Total DOAC medicines dispensed in primary care in England, 2020

```{r plotly_vertical_bar_output, message = FALSE, warning = FALSE, echo = FALSE}
plotly_vbar_chart
```

##### Horizontal bar chart

Use chart_type = "horizontal_bar".

```{r plotly_horizontal_bar}
# Create chart
plotly_vbar_chart <- bar_df %>%
  # Reorder chemical factor levels in decreasing order of items
  mutate(chemical = reorder(chemical, items)) %>% 
  plot_ly(x = ~items,
          y = ~chemical,
          type = "bar",
          # Make horizontal
          orientation = "h",
          # Bold teal bars with black outline
          marker = list(color = nice_colours_full[["bold_teal_100"]],
                        line = list(color = nice_colours_full[['black_100']], width = 1.5))) %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "horizontal_bar",
             x_title = "Dispensed items (millions)",
             y_title = "")

plotly_vbar_chart
```
##### Line chart

Use chart_type = "line".

```{r plotly_line, message = FALSE, warning = FALSE}
# Create chart
plotly_line_chart <- line_df %>%
  plot_ly(x = ~date,
          y = ~items,
          type = "scatter",
          # Line with marker dot at each data point
          mode = "lines+markers",
          # Make line and dots teal
          marker = list(color = nice_colours_full[["bold_teal_100"]])) %>%
  # Add the vertical dashed line to show lockdown date. Added this before plotting the 
  # data so that it sits on a layer behind the line and points
  add_lines(x = as.Date("2020-03-01"),
            y = ~c(0, max(items)),
            line = list(dash = "dash",
                        color = "#000000",
                        width = 1.5),
            # Don't inherit properties of previous trace
            inherit = FALSE) %>% 
  layout(showlegend = FALSE,
         xaxis = list(type = "date", # Specify x axis is date
                      # Show x axis ticks
                      ticks = "outside", 
                      # Format ticks as abbreviated month name and full year, e.g. Jan 2018
                      tickformat = "%b\n%Y",
                      # Set first tick
                      tick0 = "2017-07-01",
                      # Tick every 6 months
                      dtick = "M6"),
          # Y axis ticks with commas as thousands separators
         yaxis = list(tickformat = ",",
                      range = ~c(0, max(items)+10000)),
         annotations = list(x = as.Date("2020-03-01"),
                            xshift = -60,
                            y = 180000,
                            text = "National lockdown\non 23 March",
                            xref = "x",
                            yref = "y",
                            showarrow = FALSE, 
                            align = "right")) %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "line",
             x_title = "",
             y_title = "Dispensed items",
             # Don't pad the axes, as ticks shown. Do not want gap between axis line and ticks
             pad_axes = FALSE)
```

**Edoxaban prescribing has increased since 2017**  
Figure x. Edoxaban prescribing in England, 2017-2022

```{r plotly_line_output, message = FALSE, warning = FALSE, echo = FALSE}
plotly_line_chart
```
##### Scatter plot

```{r plotly_scatter, message = FALSE, warning = FALSE}

# Create chart
plotly_scatter_chart <- scatter_df %>%
  plot_ly(x = ~total_list_size,
          y = ~items,
          type = "scatter",
          mode = "markers",
          marker = list(color = nice_colours_full[["bold_teal_100"]])
          ) %>% 
  layout(showlegend = FALSE,
         # Axis ticks with commas as thousands separators
         xaxis = list(tickformat = ","),
         yaxis = list(tickformat = ",")) %>% 
  # Add NICE theme and set axis titles
  nice_plotly_theme(chart_type = "scatter",
             x_title = "Primary care list size (x1000)",
             y_title = "Dispensed items",
             # Don't pad the axes, as ticks shown. Do not want gap between axis line and ticks
             pad_axes = FALSE)
```

**Apixaban prescribing**  
Items of apixaban dispensed in primary care compared to sub-ICB location list size, July 2021

```{r plotly_scatter_output, echo = FALSE, message = FALSE, warning = FALSE}
plotly_scatter_chart
```

##### Faceted charts

The easiest way to [make faceted charts in Plotly is to make it in ggplot](https://plotly.com/ggplot2/facet-plots/) and then convert it into a Plotly chart using the function ggplotly. 

```{r ggplotly_facet, message = FALSE, warning = FALSE}

# Create chart
ggplotly(facet_chart)
```

```{r plotly_facet, message = FALSE, warning = FALSE}

facet_template <- function(i) {

  chemicals <- unique(facet_df$chemical)
  
  facet_df %>% 
    filter(chemical == chemicals[[i]]) %>% 
    plot_ly(x = ~date,
            y = ~items,
            type = "scatter",
            mode = "lines+markers",
            marker = list(color = nice_colours[[i]]),
            name = chemicals[[i]]) %>% 
    layout(showlegend = FALSE,
           xaxis = list(type = "date", # Specify x axis is date
                        # Show x axis ticks
                        ticks = "outside", 
                        # Format ticks as abbreviated month name and full year, e.g. Jan 2018
                        tickformat = "%b\n%Y",
                        # Outline box around plot
                        showline = TRUE,
                        mirror = "all"),
           yaxis = list(showline = TRUE,
                        mirror = "all"),
           # Subplot titles
           annotations = list(xref = 'paper',
                             yref = 'paper',
                             yanchor = 'bottom',
                             xanchor = 'center',
                             align = 'center',
                             x = .5,
                             y = 1,
                             showarrow = FALSE,
                             text = chemicals[[i]],
                             bgcolor = nice_colours[[1]],
                             font = list(color = "#ffffff"))) %>% 
    nice_plotly_theme(chart_type = "line",
             x_title = "",
             y_title = "Dispensed items (thousands)",
             # Don't pad the axes, as ticks shown. Do not want gap between axis line and ticks
             pad_axes = FALSE)
}

plot_list <- map(1:length(unique(facet_df$chemical)), facet_template)

subplot(plot_list, shareX = TRUE, shareY = TRUE)
```

